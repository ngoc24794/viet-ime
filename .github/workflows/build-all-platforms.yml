name: Build All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Táº¡o Release?'
        type: boolean
        default: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Windows (WPF) â€” chá»‰ build Ä‘Æ°á»£c trÃªn Windows
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish Windows
        run: |
          dotnet publish src/VietIME.App -c Release -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o ./publish/win

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VietIME-Windows
          path: ./publish/win/VietIME.exe

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # macOS (Avalonia) â€” build trÃªn macOS runner
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish macOS (arm64)
        run: |
          dotnet publish src/VietIME.Mac.App -c Release -r osx-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true \
            -o ./publish/mac-arm64

      - name: Publish macOS (x64)
        run: |
          dotnet publish src/VietIME.Mac.App -c Release -r osx-x64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true \
            -o ./publish/mac-x64

      - name: Create DMG (arm64)
        run: |
          mkdir -p ./dmg-staging
          cp ./publish/mac-arm64/VietIME ./dmg-staging/
          chmod +x ./dmg-staging/VietIME
          hdiutil create -volname "VietIME" -srcfolder ./dmg-staging \
            -ov -format UDZO ./publish/VietIME-arm64.dmg

      - name: Create DMG (x64)
        run: |
          rm -rf ./dmg-staging/*
          cp ./publish/mac-x64/VietIME ./dmg-staging/
          chmod +x ./dmg-staging/VietIME
          hdiutil create -volname "VietIME" -srcfolder ./dmg-staging \
            -ov -format UDZO ./publish/VietIME-x64.dmg

      - name: Prepare release artifacts
        run: |
          mkdir -p ./publish/release-mac
          cp ./publish/VietIME-arm64.dmg ./publish/release-mac/
          cp ./publish/VietIME-x64.dmg ./publish/release-mac/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VietIME-macOS
          path: ./publish/release-mac/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Linux (Avalonia + evdev) â€” build trÃªn Ubuntu
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish Linux (x64)
        run: |
          dotnet publish src/VietIME.Linux.App -c Release -r linux-x64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true \
            -o ./publish/linux

      - name: Prepare binary
        run: |
          chmod +x ./publish/linux/VietIME
          # Táº¡o tar.gz vÃ  copy binary ra cÃ¹ng thÆ° má»¥c Ä‘á»ƒ artifact flat
          mkdir -p ./publish/release-linux
          cp ./publish/linux/VietIME ./publish/release-linux/VietIME
          cd ./publish/linux && tar -czf ../release-linux/VietIME-linux-x64.tar.gz VietIME

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VietIME-Linux
          path: ./publish/release-linux/

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Release â€” gom artifact tá»« 3 jobs, táº¡o GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p ./release
          # Windows
          cp ./artifacts/VietIME-Windows/VietIME.exe ./release/VietIME.exe
          # macOS
          cp ./artifacts/VietIME-macOS/VietIME-arm64.dmg ./release/VietIME-arm64.dmg
          cp ./artifacts/VietIME-macOS/VietIME-x64.dmg ./release/VietIME-x64.dmg
          # Linux
          cp ./artifacts/VietIME-Linux/VietIME ./release/VietIME
          cp ./artifacts/VietIME-Linux/VietIME-linux-x64.tar.gz ./release/VietIME-linux-x64.tar.gz

          echo "ğŸ“¦ Artifacts structure:"
          find ./artifacts -type f

          echo "ğŸ“¦ Release files:"
          ls -lh ./release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release/*
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸ‡»ğŸ‡³ VietIME â€” Bá»™ gÃµ Tiáº¿ng Viá»‡t

            ### Táº£i xuá»‘ng
            | Ná»n táº£ng | File | Ghi chÃº |
            |----------|------|---------|
            | ğŸªŸ Windows | `VietIME.exe` | Portable, khÃ´ng cáº§n cÃ i Ä‘áº·t |
            | ğŸ macOS (Apple Silicon) | `VietIME-arm64.dmg` | M1/M2/M3/M4 |
            | ğŸ macOS (Intel) | `VietIME-x64.dmg` | Mac Intel |
            | ğŸ§ Linux | `VietIME` hoáº·c `VietIME-linux-x64.tar.gz` | Ubuntu/Debian x86_64 |

            ### CÃ i Ä‘áº·t nhanh (1 lá»‡nh)
            **macOS / Linux:**
            ```bash
            curl -sSL https://raw.githubusercontent.com/donamvn/viet-ime/master/scripts/install.sh | bash
            ```
            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/donamvn/viet-ime/master/scripts/install.ps1 | iex
            ```

            ### PhÃ­m táº¯t
            - **Windows**: `Ctrl + Shift` báº­t/táº¯t
            - **macOS**: `âŒ˜ + ~` báº­t/táº¯t
            - **Linux**: `Ctrl + ~` báº­t/táº¯t
